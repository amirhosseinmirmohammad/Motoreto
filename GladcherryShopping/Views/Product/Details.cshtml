@model DataLayer.ViewModels.ProductDetailViewModel
@{
    var productName = Model?.product?.PersianName ?? "محصول";
    var productEnglishName = Model?.product?.EnglishName ?? "";
    var productDesc = string.IsNullOrEmpty(Model?.product?.Description)
        ? "توضیحات محصول در دسترس نیست."
        : GladCherryShopping.Helpers.FunctionsHelper.Truncate(Model.product.Description, 160);

    var productImage = string.IsNullOrEmpty(Model?.product?.SiteFirstImage)
        ? Url.Content("~/images/sadr_logo.png")
        : Model.product.SiteFirstImage;

    var productCategory = Model?.product?.category?.PersianName ?? "بدون دسته‌بندی";
    var parentCategory = Model?.product?.category?.Parent?.PersianName ?? "دسته اصلی";
    var parentCategoryId = Model?.product?.category?.Parent?.Id ?? 0;
    var categoryId = Model?.product?.category?.Id ?? 0;
    var stock = Model?.product?.Stock ?? 0;
    var minBuy = Model?.product?.Min ?? 0;
    var unitPrice = Model?.product?.UnitPrice ?? 0;
    var discountPercent = Model?.product?.DiscountPercent ?? 0;
}

@{
    ViewBag.Title = productName + " | خرید آنلاین از موتورتو";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Metas{
    <meta name="description" content="@productDesc" />
    <meta property="og:title" content="@productName | موتورتو" />
    <meta property="og:image" content="@productImage" />
    <meta property="og:url" content="@Url.Action("Details","Product", new { id=Model?.product?.Id}, Request.Url.Scheme)" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content="@productImage" />
}

@section Styles{
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet" />
}

<!-- breadcrumb -->
<nav class="breadcrumb">
    <a href="/">صفحه اصلی</a> /
    <a href="/product/bycar/@parentCategory">@parentCategory</a> /
    <a href="/product/bycar/@productCategory/">@productCategory</a> /
    <span>@productName</span>
</nav>

<div class="container">
    <div class="row">
        <!-- gallery -->
        <div class="col-md-6">
            <div class="product-gallery">
                <div class="main-image">
                    <a href="@productImage" data-lightbox="product-gallery">
                        <img id="mainProductImage" src="@productImage" alt="@Model?.product?.PersianName" />
                    </a>
                </div>
                <div class="thumbs">
                    <a href="@productImage" data-lightbox="product-gallery">
                        <img src="@productImage" alt="@Model?.product?.PersianName" />
                    </a>

                    @foreach (var img in Model.product.Images)
                    {
                        <a href="@img.Link" data-lightbox="product-gallery">
                            <img src="@img.Link" alt="@Model?.product?.PersianName" />
                        </a>
                    }
                </div>
            </div>
        </div>

        <!-- info -->
        <div class="col-md-6">
            <div class="product-meta">
                <h1>@productName</h1>
                <h2>@productEnglishName</h2>
                <div class="price">
                    @if (discountPercent > 0)
                    {
                        <span class="discount">% @discountPercent</span>
                        <del>
                            <span class="amount">@string.Format("{0:n0}", unitPrice)</span>
                            <span class="currency">ریال</span>
                        </del>
                        <ins>
                            <span class="amount">
                                @string.Format("{0:n0}", unitPrice - (unitPrice * discountPercent / 100))
                            </span>
                            <span class="currency">ریال</span>
                        </ins>
                    }
                    else
                    {
                        <ins>
                            <span class="amount">@string.Format("{0:n0}", unitPrice)</span>
                            <span class="currency">ریال</span>
                        </ins>
                    }
                </div>
                <div class="stock">
                    @if (stock > 0)
                    {
                        <span class="in-stock">موجود</span>
                    }
                    else
                    {
                        <span class="out-of-stock">ناموجود</span>
                    }
                </div>
                <button class="btn-addcart btncard" productid="@Model.product.Id">
                    افزودن به سبد خرید
                </button>
            </div>
        </div>
    </div>

    <!-- tabs -->
    <div class="product-tabs">
        <ul class="tab-nav">
            <li class="active" data-tab="desc">توضیحات</li>
            <li data-tab="specs">مشخصات</li>
            <li data-tab="reviews">دیدگاه‌ها</li>
        </ul>
        <div class="tab-content active" id="desc">@Html.Raw(Model?.product?.Description ?? "توضیحی ثبت نشده")</div>
        <div class="tab-content" id="specs">
            <table class="table">
                <tr><td>دسته‌بندی</td><td>@productCategory</td></tr>
                <tr><td>موجودی</td><td>@(stock > 0 ? stock.ToString() : "ناموجود")</td></tr>
                <tr><td>حداقل خرید</td><td>@(minBuy > 0 ? minBuy.ToString() : "ثبت نشده")</td></tr>
            </table>
        </div>
        <div class="tab-content" id="reviews">
            @if (Model?.product?.Comments != null && Model.product.Comments.Count() > 0)
            {
                foreach (var c in Model.product.Comments)
                {
                    <div class="review"><b>@c.Fullname</b><br /><p>@c.Text</p></div>
                }
            }
            else
            {
                <p>هیچ دیدگاهی ثبت نشده است.</p>
            }
        </div>
    </div>

    <!-- related -->
    @if (Model?.product?.RelatedProducts != null && Model.product.RelatedProducts.Count() > 0)
    {
        <h2>محصولات مرتبط</h2>
        <div class="related-slider">
            @foreach (var item in Model.product.RelatedProducts)
            {
                var relatedImage = string.IsNullOrEmpty(item.SiteFirstImage)
                    ? Url.Content("~/images/sadr_logo.png")
                    : item.SiteFirstImage;
                <a href="/Product/Details/@item.Id" class="related-item">
                    <img src="@relatedImage" alt="@item.PersianName" />
                    <span>@item.PersianName</span><br />
                    <span class="price">
                        <span class="amount">@string.Format("{0:n0}", item.UnitPrice)</span>
                        <span class="currency">ریال</span>
                    </span>
                </a>
            }
        </div>
    }
</div>

<!-- Review -->
<div class="product-review">
    <h2>نقد و بررسی اجمالی @Model.product.PersianName</h2>
    <p>
        اگر به دنبال محصولی مطمئن و با کیفیت هستید،
        <strong>@Model.product.PersianName</strong>
        می‌تواند انتخابی عالی باشد.
    </p>
    <ul>
        <li>کیفیت ساخت بالا</li>
        <li>قیمت مناسب</li>
        <li>سازگار با اکثر خودروها</li>
    </ul>
</div>

<div class="product-faq">
    <h2>سؤالات متداول</h2>
    <div class="faq-item">
        <h4>آیا این محصول دارای ضمانت اصالت کالا است؟</h4>
        <p>بله، تمام محصولات موتورتو با ضمانت اصالت کالا ارائه می‌شوند.</p>
    </div>
    <div class="faq-item">
        <h4>ارسال چقدر طول می‌کشد؟</h4>
        <p>برای تهران 24 ساعت و سایر شهرها 2 تا 4 روز کاری.</p>
    </div>
    <div class="faq-item">
        <h4>آیا امکان مرجوع کردن وجود دارد؟</h4>
        <p>بله، تا 7 روز پس از خرید در صورت ایراد یا مغایرت قابل مرجوع است.</p>
    </div>
</div>

<!-- Schema Product + Review + FAQ -->
<script type="application/ld+json">
{
  "@@context":"https://schema.org",
  "@@type":"Product",
  "name":"@productName",
  "image":"@productImage",
  "description":"@productDesc",
  "brand":"Motoreto",
  "offers": {
    "@@type":"Offer",
    "price":"@unitPrice",
    "priceCurrency":"IRR",
    "availability":"@(stock>0 ? "https://schema.org/InStock" : "https://schema.org/OutOfStock")"
  },
  "aggregateRating": {
    "@@type": "AggregateRating",
    "ratingValue": "5",
    "reviewCount": "@(Model?.product?.Comments?.Count() ?? 1)"
  }
}
</script>

<script type="application/ld+json">
    {
      "@@context": "https://schema.org/",
      "@@type": "FAQPage",
      "mainEntity": [
        {
          "@@type": "Question",
          "name": "آیا این محصول ضمانت دارد؟",
          "acceptedAnswer": { "@@type": "Answer", "text": "بله، همه محصولات موتورتو ضمانت اصالت دارند." }
        },
        {
          "@@type": "Question",
          "name": "ارسال چقدر طول می‌کشد؟",
          "acceptedAnswer": { "@@type": "Answer", "text": "برای تهران 24 ساعت و سایر شهرها 2 تا 4 روز کاری." }
        },
        {
          "@@type": "Question",
          "name": "آیا امکان مرجوعی وجود دارد؟",
          "acceptedAnswer": { "@@type": "Answer", "text": "بله، تا 7 روز پس از خرید در صورت مشکل می‌توانید مرجوع کنید." }
        }
      ]
    }
</script>

@section Scripts{
    <script>
        $(".product-tabs .tab-nav li").click(function () {
            var tab = $(this).data("tab");
            $(".product-tabs .tab-nav li").removeClass("active");
            $(this).addClass("active");
            $(".tab-content").removeClass("active");
            $("#" + tab).addClass("active");
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
    <script>
        lightbox.option({
            'resizeDuration': 200,
            'wrapAround': true,
            'fadeDuration': 200,
            'albumLabel': "تصویر %1 از %2"  // ← فارسی
        })
    </script>
}
